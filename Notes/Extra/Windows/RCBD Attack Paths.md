
### S4U2Self and S4U2Proxy Attack Table

| **What to Enumerate**                | **How to Exploit**                                                                                                                                                                                                 | **Special Permissions Required**                                                                                                                                                     |
|--------------------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Service Accounts with SPNs**       | Enumerate service accounts that have SPNs registered using tools like `GetUserSPNs.py` or PowerShell (`Get-ADUser -Filter {ServicePrincipalName -ne $null}`), and then use S4U2Self to request a TGT for these users. | The attacker needs to have control over a service account with `SeTcbPrivilege` or `SeAssignPrimaryTokenPrivilege` to request a TGT on behalf of another user.                                                            |
| **Service Accounts with Delegation** | Use PowerView or other enumeration tools to find service accounts configured for delegation (`Get-DomainUser -TrustedToAuth` in PowerView). Exploit by requesting TGS tickets via S4U2Proxy.                          | The service account needs to have "Trust this user for delegation to specified services only" (Constrained Delegation) or Resource-Based Constrained Delegation (RBCD) permissions.                                           |
| **Resource-Based Constrained Delegation (RBCD)** | Identify resources configured for RBCD using tools like `Get-DomainObjectAcl` (PowerView) to find objects with `msDS-AllowedToActOnBehalfOfOtherIdentity` set. Exploit by using S4U2Proxy to impersonate a user and access the resource. | You must have permissions to modify the `msDS-AllowedToActOnBehalfOfOtherIdentity` attribute on the target resource (often requires control of a machine or service account).                                                  |
| **Permissions on the Target Service**| After identifying a target service (e.g., SQL Server) via SPN enumeration, use S4U2Proxy to request a TGS for the service on behalf of another user, then access the service using the TGS.                          | The attacker must have a service account with delegation rights to the target service, and the target user must have the `SeDelegateSessionUser` or similar permissions on the service.                                        |
| **Service Accounts with Admin Rights**| Enumerate service accounts that are members of privileged groups (e.g., Domain Admins). Use S4U2Self to request a TGT for these accounts, and then use S4U2Proxy to access other resources or escalate privileges.    | The attacker needs control over a service account configured with delegation, and the service account must have `SeTcbPrivilege` or `SeAssignPrimaryTokenPrivilege` to request TGTs for privileged accounts.                   |
| **Kerberoasting with S4U2Self**      | Use S4U2Self to request TGTs for service accounts with SPNs, and then use S4U2Proxy to request TGS tickets for specific services. Crack these tickets offline to recover service account credentials.                 | The attacker needs control over a service account that can request TGTs via S4U2Self, and the account must have the necessary delegation rights to impersonate other users or service accounts.                                |
| **Cross-Domain Delegation**          | Enumerate trusts and delegation settings across domains using tools like BloodHound. Exploit cross-domain delegation by requesting tickets via S4U2Proxy to access resources in other domains.                        | The attacker must have an account in one domain with delegation rights configured for services in another domain. Requires appropriate delegation configuration in cross-domain environments.                                  |
| **Abusing SPN for Domain Admin Access** | After finding an SPN for a service running under a Domain Admin account, use S4U2Self to request a TGT for the Domain Admin, then use S4U2Proxy to request a TGS for another service, eventually leading to domain-wide access. | The attacker must have control over a service account with delegation rights and the ability to request TGTs on behalf of privileged accounts (e.g., Domain Admins). This usually requires `SeTcbPrivilege` or similar rights. |

### Summary of the Table Columns:

1. **What to Enumerate**: Identifies the key objects or configurations you should enumerate to determine potential attack vectors with S4U2Self and S4U2Proxy.
2. **How to Exploit**: Describes the method for exploiting the identified enumeration, such as requesting tickets or accessing resources using S4U2Self and S4U2Proxy.
3. **Special Permissions Required**: Details the specific permissions or rights the attacker’s account must possess to carry out the exploitation successfully.

### Key Takeaways:
- **S4U2Self**: Allows a service account to request a service ticket on behalf of another user, typically requiring privileges like `SeTcbPrivilege` or `SeAssignPrimaryTokenPrivilege`.
- **S4U2Proxy**: Enables the forwarding of a ticket to another service, often used in conjunction with delegation configurations like Resource-Based Constrained Delegation (RBCD) or traditional constrained delegation.
- **Permissions and Configurations**: Successful exploitation generally requires that the attacker has control over a service account with specific delegation rights and that the target service is configured to allow delegation.

This table provides a concise reference for common attack paths involving S4U2Self and S4U2Proxy, along with the necessary permissions and exploitation techniques.

Certainly! Resource-Based Constrained Delegation (RBCD) can be exploited in various ways beyond the typical S4U2Self and S4U2Proxy attacks. Here’s a table that outlines other RBCD-related attacks, including what to enumerate, how to exploit, and the special permissions required.

### **RBCD Attack Table**

| **What to Enumerate**                         | **How to Exploit**                                                                                                                                                         | **Special Permissions Required**                                                                                                                                                     |
|-----------------------------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Computers Trusted for RBCD**                | Enumerate computers that have `msDS-AllowedToActOnBehalfOfOtherIdentity` configured using PowerView or BloodHound. Exploit by modifying this attribute to add malicious entries. | The attacker must have permissions to modify the `msDS-AllowedToActOnBehalfOfOtherIdentity` attribute on the target computer (requires control over a computer or elevated AD permissions).                                      |
| **Vulnerable Service Accounts with RBCD**     | Identify service accounts configured with RBCD. Use a controlled machine account to impersonate privileged users and access resources or move laterally.                       | The attacker must control a computer account with the ability to modify its own `msDS-AllowedToActOnBehalfOfOtherIdentity` attribute, or the attacker must have write access to the service account’s object in AD.             |
| **Misconfigured RBCD on Domain Controllers**  | Enumerate domain controllers with RBCD configured. Exploit by adding a low-privilege machine account to the DC's `msDS-AllowedToActOnBehalfOfOtherIdentity`, then request TGS as a domain admin. | The attacker must have write permissions to the DC’s `msDS-AllowedToActOnBehalfOfOtherIdentity` attribute (highly dangerous if DCs are misconfigured with overly permissive ACLs).                                               |
| **Cross-Forest Trusts with RBCD**             | Enumerate cross-forest trusts and RBCD configurations. Exploit by adding accounts from one forest to the `msDS-AllowedToActOnBehalfOfOtherIdentity` attribute in the trusted forest. | The attacker must have administrative control or write access in one forest and the ability to modify `msDS-AllowedToActOnBehalfOfOtherIdentity` in the trusted forest.                                                        |
| **Service Accounts with Delegation**          | Find service accounts with delegation rights that can be modified. Add or modify delegation entries to allow for further exploitation using RBCD.                            | The attacker must have control over a service account or sufficient privileges to modify the `msDS-AllowedToActOnBehalfOfOtherIdentity` attribute on the target service account in Active Directory.                            |
| **Accounts with AdminSDHolder Applied**       | Identify accounts with `AdminSDHolder` protection (e.g., Domain Admins), and check if RBCD is applied. Exploit by abusing the service accounts configured with RBCD to access these accounts. | The attacker needs the ability to modify the `msDS-AllowedToActOnBehalfOfOtherIdentity` on service accounts that can interact with protected accounts, requiring control over service accounts or write access to AD objects.      |
| **Computers with Write Permissions to RBCD**  | Enumerate computers where the attacker has write permissions to the `msDS-AllowedToActOnBehalfOfOtherIdentity` attribute. Exploit by modifying these attributes to escalate privileges. | The attacker must have permissions to modify the `msDS-AllowedToActOnBehalfOfOtherIdentity` attribute, often requiring administrative privileges or control over specific computer or service accounts in AD.                      |
| **Exploiting RBCD via Service Tickets**       | Enumerate service accounts that can obtain service tickets via RBCD. Use these tickets to access resources as other users, potentially leading to lateral movement or privilege escalation. | The attacker must control a machine or service account that has RBCD rights and can request service tickets for other users. Control over RBCD-enabled accounts or machines is necessary for exploitation.                          |
| **Abusing RBCD for Persistence**              | After compromising a machine or service account, configure RBCD on high-value targets to maintain access even after password resets. Use service tickets to maintain persistence.  | The attacker must control a machine or service account with the ability to modify the `msDS-AllowedToActOnBehalfOfOtherIdentity` attribute. Persistence is maintained by controlling delegation configurations on critical resources. |

### Summary of the Table Columns:

1. **What to Enumerate**: Identifies key objects, configurations, or attributes to enumerate in order to determine potential attack vectors involving RBCD.
2. **How to Exploit**: Describes how to exploit the identified vulnerabilities, such as modifying `msDS-AllowedToActOnBehalfOfOtherIdentity` attributes or abusing cross-forest trusts.
3. **Special Permissions Required**: Details the specific permissions or rights the attacker’s account must possess to carry out the exploitation successfully.

### Key RBCD Attack Paths:

- **Privilege Escalation via RBCD**: By adding malicious entries to `msDS-AllowedToActOnBehalfOfOtherIdentity`, attackers can escalate privileges by impersonating higher-privileged users or accounts.
- **Lateral Movement**: Attackers can exploit RBCD to move laterally within a domain by modifying delegation configurations and accessing services as other users.
- **Persistence**: RBCD can be abused to maintain access to critical resources, even after the initial compromise is remediated, by configuring persistent delegation rights.
- **Cross-Forest Attacks**: Exploiting RBCD in cross-forest environments can allow attackers to bridge trust boundaries and escalate privileges across different forests.

### Final Notes:

RBCD is a powerful feature in Active Directory, but if misconfigured, it can lead to significant security risks. Attackers can exploit these configurations to gain unauthorized access, escalate privileges, or maintain persistence in a network. Understanding and securing RBCD configurations is essential for protecting a Windows environment from advanced attacks.